name: Patch IPA
on: workflow_dispatch

jobs:
  patch:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install insert_dylib
        run: |
          git clone https://github.com/Tyilo/insert_dylib
          cd insert_dylib && xcodebuild && cp build/Release/insert_dylib /usr/local/bin/insert_dylib

      - name: Patch IPA
        run: |
          curl -L https://github.com/frida/frida/releases/download/17.7.3/frida-gadget-17.7.3-ios-universal.dylib.xz -o gadget.xz
          xz -d gadget.xz
          mv gadget frida-gadget.dylib
          mkdir -p work
          unzip carrefour.ipa -d work/app
          APP=$(ls work/app/Payload/)
          BINARY=$(defaults read "$(pwd)/work/app/Payload/$APP/Info.plist" CFBundleExecutable)
          mkdir -p "work/app/Payload/$APP/Frameworks"
          cp frida-gadget.dylib "work/app/Payload/$APP/Frameworks/FridaGadget.dylib"
          insert_dylib --strip-codesig --inplace "@executable_path/Frameworks/FridaGadget.dylib" "work/app/Payload/$APP/$BINARY"
          cd work/app && zip -qr ../../carrefour-patched.ipa Payload
          ls -la ../../carrefour-patched.ipa

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: carrefour-patched
          path: carrefour-patched.ipa
