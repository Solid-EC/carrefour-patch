name: Patch IPA
on: workflow_dispatch

jobs:
  patch:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install tools
        run: |
          git clone https://github.com/Tyilo/insert_dylib
          cd insert_dylib && xcodebuild && cp build/Release/insert_dylib /usr/local/bin/insert_dylib
          curl -L https://github.com/frida/frida/releases/download/17.7.3/frida-gadget-17.7.3-ios-universal.dylib.xz -o gadget.xz
          xz -d gadget.xz
          mv gadget frida-gadget.dylib

      - name: Patch IPA manually
        run: |
          mkdir -p work
          cp carrefour.ipa work/
          cd work
          unzip carrefour.ipa -d app
          APP=$(ls app/Payload/)
          BINARY=$(defaults read "$(pwd)/app/Payload/$APP/Info.plist" CFBundleExecutable)
          cp ../frida-gadget.dylib "app/Payload/$APP/Frameworks/FridaGadget.dylib" 2>/dev/null || (mkdir -p "app/Payload/$APP/Frameworks" && cp ../frida-gadget.dylib "app/Payload/$APP/Frameworks/FridaGadget.dylib")
          insert_dylib --strip-codesig --inplace "@executable_path/Frameworks/FridaGadget.dylib" "app/Payload/$APP/$BINARY"
          cd app && zip -qr ../carrefour-patched.ipa Payload
          cd ..
          ls -la *.ipa

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: carrefour-patched
          path: work/carrefour-patched.ipa
